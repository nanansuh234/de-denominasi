<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MONITOR V4.1 (SECURE AUDIT)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --gold: #d4af37; --dark: #0f0f0f; --panel: #1a1a1a; --text: #eee; --accent: #00d2ff; --flow: #00ffaa; --err: #ff4444; }
        body { background: var(--dark); color: var(--text); font-family: 'Segoe UI', monospace; margin: 0; padding: 15px; padding-bottom: 50px; user-select: none; }
        
        .header { border-bottom: 2px solid var(--gold); padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        h2 { color: var(--gold); margin: 0; font-size: 1.1rem; letter-spacing: 1px; }
        .live-badge { background: #004400; color: #00ff00; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; border: 1px solid #00ff00; display: inline-block; margin-top: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* KPI - UPDATED TO 3 COLUMNS */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .card { background: var(--panel); border: 1px solid #333; padding: 10px; border-radius: 8px; text-align: center; display:flex; flex-direction:column; justify-content:center; }
        .card-title { color: #888; font-size: 0.55rem; margin-bottom: 2px; text-transform: uppercase; }
        .card-val { font-size: 1rem; font-weight: bold; color: var(--gold); }
        
        .card-err { border-color: var(--err); background: rgba(50,0,0,0.3); }
        .card-err .card-val { color: var(--err); }

        /* LOG TRAFFIC (CCTV) */
        .log-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .log-container { 
            background: #000; border: 1px solid var(--flow); border-radius: 8px; 
            height: 250px; 
            overflow-y: auto; 
            padding: 8px; font-size: 0.75rem; margin-bottom: 15px; position: relative; 
        }
        .log-item { border-bottom: 1px solid #222; padding: 5px 0; display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .log-time { color: #555; margin-right: 5px; font-size: 0.65rem; }
        .log-flow { color: #fff; flex-grow: 1; margin: 0 5px; }
        .log-val { color: var(--flow); font-weight: bold; }
        .arrow { color: #666; margin: 0 3px; }
        .coin-ref { font-size: 0.6rem; color: #444; margin-left: 5px; }

        .log-item.fake-trx { background: rgba(50,0,0,0.5); border-bottom: 1px solid var(--err); }
        .log-item.fake-trx .log-val { color: var(--err); text-decoration: line-through; }

        /* WALLET TABLE */
        .panel-box { margin-top: 15px; border-top: 1px dashed #333; padding-top: 10px; }
        .panel-head { font-size: 0.9rem; font-weight: bold; color: var(--accent); margin-bottom: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; color: #666; padding: 6px; border-bottom: 1px solid #444; font-size: 0.7rem; }
        td { padding: 6px; border-bottom: 1px solid #222; }
        .col-right { text-align: right; }
        
        .search-box { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; margin-bottom: 8px; box-sizing: border-box; font-size: 0.9rem; }
        .u-name { color: #eee; font-weight: bold; font-size: 0.85rem; }
        .u-id { color: #666; font-size: 0.6rem; }
        
        #loadStatus { font-size: 0.7rem; color: #666; text-align: center; margin-bottom: 5px; font-style: italic; }
        #trxCounter { background: #333; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div class="header">
        <h2>MONITOR V4.1 (SECURE AUDIT)</h2>
        <div class="live-badge">‚óè CCTV AKTIF</div>
    </div>

    <div class="log-header">
        <div style="font-size:0.75rem; color:var(--flow); font-weight:bold;">LIVE TRAFFIC</div>
        <div id="trxCounter">0 Transaksi</div>
    </div>
    
    <div class="log-container" id="trafficLog">
        <div id="emptyLog" style="text-align:center; color:#444; padding-top:100px;">
            Menunggu pergerakan...<br>
            <span style="font-size:0.7rem;">(Max buffer: 100 riwayat)</span>
        </div>
    </div>

    <div id="loadStatus">Menghubungkan Database...</div>

    <div class="kpi-grid">
        <div class="card">
            <div class="card-title">TOTAL BEREDAR (ASLI)</div>
            <div class="card-val" id="totalSupply">...</div>
        </div>
        <div class="card card-err">
            <div class="card-title">‚ö†Ô∏è TOKEN PALSU</div>
            <div class="card-val" id="fakeTokenDisplay">0</div>
        </div>
        <div class="card">
            <div class="card-title">USER AKTIF</div>
            <div class="card-val" id="totalUsers" style="color:#fff">...</div>
        </div>
    </div>

    <div class="panel-box">
        <div class="panel-head">SALDO USER (VALIDATED)</div>
        <input type="text" id="searchWallet" class="search-box" placeholder="Cari Nama / ID..." onkeyup="filterWallet()">
        <div style="max-height: 250px; overflow-y: auto;">
            <table id="walletTable">
                <thead>
                    <tr>
                        <th>NAMA / ID</th>
                        <th class="col-right">SALDO</th>
                    </tr>
                </thead>
                <tbody id="walletBody">
                    <tr><td colspan="2" style="text-align:center; color:#444;">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVyuckZYUdUSPwX86fGy7n8KPOt7pWoVQ",
        authDomain: "pasarnuswantara.firebaseapp.com",
        databaseURL: "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pasarnuswantara",
        storageBucket: "pasarnuswantara.firebasestorage.app",
        messagingSenderId: "8346470668",
        appId: "1:8346470668:web:86a7e8e1c19054260a2129",
        measurementId: "G-LD35EPEB7Z"
    };

    try { firebase.initializeApp(firebaseConfig); } catch(e){}
    const db = firebase.database();
    const LEDGER_NODE = 'public_ledger';

    let userMap = {}; 
    let ledgerCache = {}; 
    let walletStats = {};
    
    // VARIABLES FOR AUDIT
    let fakeTokenCount = 0;
    let fakeTokenValue = 0;
    
    let loadedCount = 0;
    let sessionTrxCount = 0;

    // --- SMART VALIDATOR ---
    function isGenuineMint(id) {
        if (!id) return false;
        // Strict Regex: Only lowercase hex, 15-32 chars
        const hexPattern = /^[a-f0-9]{15,32}$/; 
        return hexPattern.test(id);
    }

    // 1. Ambil Nama User
    db.ref('users').on('value', (snap) => {
        if(snap.exists()) {
            snap.forEach(u => { const d = u.val(); userMap[d.walletID] = d.name; });
            scheduleUIUpdate();
        }
    });

    // 2. MONITORING LEDGER
    const ledgerRef = db.ref(LEDGER_NODE);

    // A. Initial Load / Add Token
    ledgerRef.on('child_added', (snapshot) => {
        const coin = snapshot.val();
        const coinId = snapshot.key;
        
        if(coin.type !== 'RECEH') return;

        // SIMPAN KE CACHE DENGAN STATUS VALIDASI
        const isValid = isGenuineMint(coinId);
        ledgerCache[coinId] = { ...coin, isValid: isValid };
        
        const owner = coin.owner || "UNKNOWN";
        const val = parseInt(coin.val) || 0;

        if (isValid) {
            // HANYA MASUK STATISTIK JIKA VALID
            if(!walletStats[owner]) walletStats[owner] = 0;
            walletStats[owner] += val;
        } else {
            // JIKA PALSU, MASUK COUNTER PALSU
            fakeTokenCount++;
            fakeTokenValue += val;
        }

        loadedCount++;
        if(loadedCount % 50 === 0) {
            document.getElementById('loadStatus').innerText = `Memindai Ledger: ${loadedCount} koin...`;
        }
        scheduleUIUpdate();
    });

    // B. Live Transaction (CCTV)
    ledgerRef.on('child_changed', (snapshot) => {
        const newCoin = snapshot.val();
        const coinId = snapshot.key;
        const oldCoin = ledgerCache[coinId];

        if(oldCoin && newCoin.type === 'RECEH') {
            if(oldCoin.owner !== newCoin.owner) {
                const amount = parseInt(newCoin.val);
                const isValid = oldCoin.isValid; // Status validasi tidak berubah saat pindah tangan

                // LOG TRANSAKSI (CCTV)
                logTransaction(oldCoin.owner, newCoin.owner, amount, coinId, isValid);

                // Update Statistik (HANYA JIKA VALID)
                if(isValid) {
                    if(walletStats[oldCoin.owner]) walletStats[oldCoin.owner] -= amount;
                    if(!walletStats[newCoin.owner]) walletStats[newCoin.owner] = 0;
                    walletStats[newCoin.owner] += amount;
                }
                // Jika palsu, tidak perlu update walletStats, karena tidak pernah masuk walletStats.

                ledgerCache[coinId] = { ...newCoin, isValid: isValid };
                scheduleUIUpdate();
            }
        } else {
            // Update cache saja jika bukan tipe receh atau data baru
            const isValid = isGenuineMint(coinId);
            ledgerCache[coinId] = { ...newCoin, isValid: isValid };
        }
    });

    // C. Burn / Wipe / Delete
    ledgerRef.on('child_removed', (snapshot) => {
        const coinId = snapshot.key;
        const oldCoin = ledgerCache[coinId];
        
        if(oldCoin) {
            const amount = parseInt(oldCoin.val);
            
            if(oldCoin.isValid) {
                // Jika token asli dihapus, kurangi saldo user
                if(walletStats[oldCoin.owner]) walletStats[oldCoin.owner] -= amount;
            } else {
                // Jika token palsu dihapus, kurangi counter palsu
                fakeTokenCount--;
                fakeTokenValue -= amount;
            }

            delete ledgerCache[coinId];
            
            logTransaction(oldCoin.owner, "üî• BURN/WIPE", amount, coinId, oldCoin.isValid);
            scheduleUIUpdate();
        }
    });

    // --- LOGIC LOGGING (UPDATED) ---
    function logTransaction(from, to, amount, coinId, isValid) {
        const container = document.getElementById('trafficLog');
        const emptyMsg = document.getElementById('emptyLog');
        if(emptyMsg) emptyMsg.style.display = 'none';

        sessionTrxCount++;
        document.getElementById('trxCounter').innerText = sessionTrxCount + " Transaksi";

        const time = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        const nameFrom = getName(from);
        const nameTo = getName(to);

        // Styling khusus untuk log token palsu
        const rowClass = isValid ? '' : 'fake-trx';
        const displayId = isValid ? `#${coinId.substr(0,4)}` : `‚õî INJECT`;

        const html = `
            <div class="log-item ${rowClass}">
                <div style="flex-grow:1;">
                    <span class="log-time">${time}</span>
                    <span style="color:#aaa">${nameFrom}</span>
                    <span class="arrow">‚ûú</span>
                    <span style="color:#fff">${nameTo}</span>
                    <span class="coin-ref">${displayId}</span>
                </div>
                <div class="log-val">Rp ${amount.toLocaleString()}</div>
            </div>
        `;
        
        container.insertAdjacentHTML('afterbegin', html);

        // Buffer limit
        while(container.children.length > 100) {
            container.lastElementChild.remove();
        }
    }

    function getName(id) {
        if(id === 'MINT') return 'üè¶ MINT';
        if(id === 'BURN') return 'üî• BURN';
        if(userMap[id]) return userMap[id].split(' ')[0]; 
        return id.substr(0,4) + '..';
    }

    let updateTimeout;
    function scheduleUIUpdate() {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(() => {
            updateWalletTable();
            document.getElementById('loadStatus').innerText = "‚óè Sistem Siap & Monitoring";
            document.getElementById('loadStatus').style.color = "var(--success)";
        }, 800);
    }

    function updateWalletTable() {
        const tbody = document.getElementById('walletBody');
        let totalMoney = 0;
        let activeUsers = 0;
        let html = "";

        // Filter: Hanya tampilkan wallet yang punya saldo valid
        let wallets = Object.keys(walletStats).map(key => ({
            id: key, bal: walletStats[key], name: userMap[key] || key
        })).filter(w => w.bal > 0 || w.id === 'MINT'); 

        wallets.sort((a,b) => b.bal - a.bal);

        wallets.forEach(w => {
            if(w.id !== 'MINT') activeUsers++;
            totalMoney += w.bal;

            let displayName = w.name;
            let subStyle = "u-id";

            if(w.id === 'MINT') { 
                displayName = "üè¶ GUDANG MINT"; 
                subStyle = "color:var(--accent)";
            }

            html += `
                <tr>
                    <td>
                        <div class="u-name">${displayName}</div>
                        ${w.id !== 'MINT' && w.name !== w.id ? `<div class="${subStyle}">${w.id}</div>` : ''}
                    </td>
                    <td class="col-right" style="font-weight:bold; color:${w.id==='MINT'?'#aaa':'var(--gold)'}">
                        Rp ${w.bal.toLocaleString()}
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html || `<tr><td colspan="2">Data Kosong</td></tr>`;
        
        document.getElementById('totalSupply').innerText = "Rp " + totalMoney.toLocaleString('id-ID');
        document.getElementById('totalUsers').innerText = activeUsers;

        // UPDATE FAKE TOKEN INDICATOR
        const fakeEl = document.getElementById('fakeTokenDisplay');
        fakeEl.innerText = `${fakeTokenCount} Token (Rp ${fakeTokenValue.toLocaleString()})`;
    }

    function filterWallet() {
        const query = document.getElementById('searchWallet').value.toLowerCase();
        const rows = document.querySelectorAll('#walletBody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PANEL MONITOR NUSWANTARA (DETEKTIF MODE)</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --gold: #d4af37; --dark: #0f0f0f; --panel: #1a1a1a; --text: #eee; --accent: #00d2ff; --err: #ff4444; }
        body { background: var(--dark); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); padding-bottom: 20px; margin-bottom: 30px; }
        h1 { color: var(--gold); margin: 0; }
        .status { font-size: 0.9rem; color: #888; }
        .live-dot { display: inline-block; width: 10px; height: 10px; background: #00ff00; border-radius: 50%; margin-right: 5px; box-shadow: 0 0 10px #00ff00; }

        /* KPI CARDS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--panel); border: 1px solid #333; padding: 20px; border-radius: 10px; text-align: center; }
        .card-title { color: #aaa; font-size: 0.8rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .card-val { font-size: 2rem; font-weight: bold; color: var(--gold); }
        .card-sub { font-size: 0.7rem; color: #666; margin-top: 5px; }

        /* KPI Error (Fake Token) */
        .card-err { border-color: var(--err); background: rgba(50,0,0,0.2); }
        .card-err .card-title { color: var(--err); }
        .card-err .card-val { color: var(--err); }

        /* TABLES & CHARTS LAYOUT */
        /* Kita ubah jadi 3 kolom biar muat tabel tersangka */
        .dashboard-split { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        @media (max-width: 1024px) { .dashboard-split { grid-template-columns: 1fr; } }

        .panel-box { background: var(--panel); border: 1px solid #333; border-radius: 10px; padding: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .panel-head { font-size: 1.1rem; font-weight: bold; color: var(--accent); margin-bottom: 15px; border-bottom: 1px dashed #444; padding-bottom: 10px; }
        
        /* Style Khusus Panel Tersangka */
        .panel-suspect { border-color: var(--err); background: rgba(20,0,0,0.3); }
        .panel-suspect .panel-head { color: var(--err); border-bottom-color: var(--err); }

        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #444; font-size: 0.8rem; }
        td { padding: 10px; border-bottom: 1px solid #222; font-family: monospace; font-size: 0.9rem; }
        tr:hover { background: #222; }
        .col-right { text-align: right; }
        .denom-badge { background: #333; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #555; }
        
        /* Warning Badge */
        .suspect-badge { background: var(--err); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }

        /* SEARCH WALLET */
        .search-box { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 5px; margin-bottom: 10px; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>PANEL ADMIN NUSWANTARA</h1>
            <div style="color:#666; font-size:0.8rem;">Monitoring Peredaran Uang & Deteksi Palsu</div>
        </div>
        <div class="status"><span class="live-dot"></span>LIVE CONNECTION</div>
    </div>

    <div class="kpi-grid">
        <div class="card">
            <div class="card-title">TOTAL UANG BEREDAR (ASLI)</div>
            <div class="card-val" id="totalSupply">Rp 0</div>
            <div class="card-sub">Total Fisik Wajib Ada</div>
        </div>
        
        <div class="card card-err">
            <div class="card-title">‚ö†Ô∏è TOKEN PALSU / INJECT</div>
            <div class="card-val" id="fakeTokenVal">Rp 0</div>
            <div class="card-sub" id="fakeTokenCount">0 Keping Terdeteksi</div>
        </div>

        <div class="card">
            <div class="card-title">JUMLAH KOIN ASLI</div>
            <div class="card-val" id="totalCoins" style="color:var(--accent)">0</div>
            <div class="card-sub">Keping Token Valid</div>
        </div>
        <div class="card">
            <div class="card-title">JUMLAH PENGGUNA</div>
            <div class="card-val" id="totalUsers" style="color:#fff">0</div>
            <div class="card-sub">Wallet ID Terdaftar</div>
        </div>
    </div>

    <div class="dashboard-split">
        <div class="panel-box">
            <div class="panel-head">RINCIAN PECAHAN</div>
            <div style="flex-grow:1; overflow-y:auto; max-height:400px;">
                <table id="denomTable">
                    <thead>
                        <tr>
                            <th>PECAHAN</th>
                            <th class="col-right">QTY</th>
                            <th class="col-right">TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="denomBody">
                        <tr><td colspan="3" style="text-align:center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div style="margin-top:10px; height:150px;">
                <canvas id="denomChart"></canvas>
            </div>
        </div>

        <div class="panel-box">
            <div class="panel-head">SALDO USER (VALID)</div>
            <input type="text" id="searchWallet" class="search-box" placeholder="Cari ID Wallet..." onkeyup="filterWallet()">
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="walletTable">
                    <thead>
                        <tr>
                            <th>WALLET ID</th>
                            <th class="col-right">SALDO</th>
                        </tr>
                    </thead>
                    <tbody id="walletBody">
                        <tr><td colspan="2" style="text-align:center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="panel-box panel-suspect">
            <div class="panel-head">üïµÔ∏è PEMEGANG TOKEN PALSU</div>
            <div style="font-size:0.75rem; color:#aaa; margin-bottom:10px;">Daftar wallet yang menyimpan token inject/palsu. (token tidak dapat di scan QR/di gunakan bertransaksi).</div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="suspectTable">
                    <thead>
                        <tr>
                            <th>WALLET ID</th>
                            <th class="col-right">NILAI PALSU</th>
                        </tr>
                    </thead>
                    <tbody id="suspectBody">
                        <tr><td colspan="2" style="text-align:center;">Aman (Kosong)</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVyuckZYUdUSPwX86fGy7n8KPOt7pWoVQ",
        authDomain: "pasarnuswantara.firebaseapp.com",
        databaseURL: "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pasarnuswantara",
        storageBucket: "pasarnuswantara.firebasestorage.app",
        messagingSenderId: "8346470668",
        appId: "1:8346470668:web:86a7e8e1c19054260a2129",
        measurementId: "G-LD35EPEB7Z"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const LEDGER_NODE = 'public_ledger';

    let allWallets = []; // Untuk fitur search

    // --- HELPER: CEK KEASLIAN MINT (SECURE ID CHECK) ---
    function isGenuineMint(id) {
        if (!id) return false;
        // Hanya Hexadecimal (0-9, a-f) dan panjang 15-32 karakter.
        const hexPattern = /^[a-f0-9]{15,32}$/; 
        return hexPattern.test(id);
    }

    // --- 2. LOGIKA UTAMA ---
    db.ref(LEDGER_NODE).on('value', (snapshot) => {
        if(!snapshot.exists()) return;

        let totalMoney = 0;
        let totalCoinCount = 0;
        
        let denomStats = {}; 
        let walletStats = {}; 
        
        // DATA UNTUK TERSANGKA
        let fakeCount = 0;
        let fakeValTotal = 0;
        let suspectStats = {}; // { "WALLET-ID": total_palsu }

        snapshot.forEach((child) => {
            const data = child.val();
            const coinId = child.key;
            
            // FILTER PENTING: HANYA RECEH
            if (data.type === 'RECEH') {
                const val = parseInt(data.val);
                const owner = data.owner || "UNKNOWN";

                if (val && !isNaN(val)) {
                    // CEK KEASLIAN TOKEN
                    if(isGenuineMint(coinId)) {
                        // === TOKEN ASLI ===
                        totalMoney += val;
                        totalCoinCount++;

                        if (!denomStats[val]) denomStats[val] = { count: 0, sum: 0 };
                        denomStats[val].count++;
                        denomStats[val].sum += val;

                        if (!walletStats[owner]) walletStats[owner] = 0;
                        walletStats[owner] += val;
                    } else {
                        // === TOKEN PALSU/INJECT ===
                        fakeCount++;
                        fakeValTotal += val;
                        
                        // CATAT TERSANGKA
                        if (!suspectStats[owner]) suspectStats[owner] = 0;
                        suspectStats[owner] += val;
                    }
                }
            }
        });

        updateUI(totalMoney, totalCoinCount, walletStats, denomStats, fakeCount, fakeValTotal, suspectStats);
    });

    function updateUI(totalMoney, totalCoinCount, walletStats, denomStats, fakeCount, fakeValTotal, suspectStats) {
        // Update KPI Card
        document.getElementById('totalSupply').innerText = "Rp " + totalMoney.toLocaleString('id-ID');
        document.getElementById('totalCoins').innerText = totalCoinCount.toLocaleString('id-ID');
        document.getElementById('totalUsers').innerText = Object.keys(walletStats).length;

        // Update KPI Palsu
        document.getElementById('fakeTokenVal').innerText = "Rp " + fakeValTotal.toLocaleString('id-ID');
        document.getElementById('fakeTokenCount').innerText = fakeCount.toLocaleString('id-ID') + " Keping Terdeteksi";

        // --- 1. TABEL PECAHAN ---
        const denomBody = document.getElementById('denomBody');
        denomBody.innerHTML = "";
        const sortedDenoms = Object.keys(denomStats).sort((a,b) => parseInt(a) - parseInt(b));
        
        let chartLabels = [];
        let chartData = [];

        sortedDenoms.forEach(d => {
            const row = denomStats[d];
            chartLabels.push(d);
            chartData.push(row.sum);

            denomBody.innerHTML += `
                <tr>
                    <td><span class="denom-badge">Rp ${parseInt(d).toLocaleString()}</span></td>
                    <td class="col-right">${row.count.toLocaleString()}</td>
                    <td class="col-right" style="color:var(--gold);">Rp ${row.sum.toLocaleString()}</td>
                </tr>
            `;
        });
        updateChart(chartLabels, chartData);

        // --- 2. TABEL WALLET (ASLI) ---
        const walletBody = document.getElementById('walletBody');
        walletBody.innerHTML = "";
        
        allWallets = Object.keys(walletStats).map(key => ({
            id: key,
            bal: walletStats[key]
        }));
        allWallets.sort((a,b) => b.bal - a.bal);

        allWallets.forEach(w => {
            walletBody.innerHTML += `
                <tr>
                    <td>${w.id}</td>
                    <td class="col-right" style="font-weight:bold;">Rp ${w.bal.toLocaleString()}</td>
                </tr>
            `;
        });

        // --- 3. TABEL TERSANGKA (BARU) ---
        const suspectBody = document.getElementById('suspectBody');
        suspectBody.innerHTML = "";
        
        // Konversi ke array & Sort dari yang terbanyak nyimpen palsu
        let suspects = Object.keys(suspectStats).map(key => ({
            id: key,
            fakeBal: suspectStats[key]
        }));
        suspects.sort((a,b) => b.fakeBal - a.fakeBal);

        if(suspects.length === 0) {
            suspectBody.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#555;">Tidak ada aktivitas mencurigakan.</td></tr>`;
        } else {
            suspects.forEach(s => {
                suspectBody.innerHTML += `
                    <tr>
                        <td style="color:#ffaaaa;">${s.id}</td>
                        <td class="col-right">
                            <span class="suspect-badge">Rp ${s.fakeBal.toLocaleString()}</span>
                        </td>
                    </tr>
                `;
            });
        }
    }

    // Fitur Search Wallet
    function filterWallet() {
        const query = document.getElementById('searchWallet').value.toUpperCase();
        const walletBody = document.getElementById('walletBody');
        walletBody.innerHTML = "";
        
        const filtered = allWallets.filter(w => w.id.toUpperCase().includes(query));
        
        if(filtered.length === 0) {
            walletBody.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#555;">Tidak ditemukan</td></tr>`;
            return;
        }

        filtered.forEach(w => {
            walletBody.innerHTML += `
                <tr>
                    <td>${w.id}</td>
                    <td class="col-right" style="font-weight:bold;">Rp ${w.bal.toLocaleString()}</td>
                </tr>
            `;
        });
    }

    // Chart.js Setup
    let myChart = null;
    function updateChart(labels, data) {
        const ctx = document.getElementById('denomChart').getContext('2d');
        if(myChart) myChart.destroy(); 

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Nilai (Rp)',
                    data: data,
                    backgroundColor: '#d4af37',
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#333' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
</script>

</body>
</html>

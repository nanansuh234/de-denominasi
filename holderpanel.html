<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PANEL MONITOR NUSWANTARA</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --gold: #d4af37; --dark: #0f0f0f; --panel: #1a1a1a; --text: #eee; --accent: #00d2ff; }
        body { background: var(--dark); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--gold); padding-bottom: 20px; margin-bottom: 30px; }
        h1 { color: var(--gold); margin: 0; }
        .status { font-size: 0.9rem; color: #888; }
        .live-dot { display: inline-block; width: 10px; height: 10px; background: #00ff00; border-radius: 50%; margin-right: 5px; box-shadow: 0 0 10px #00ff00; }

        /* KPI CARDS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--panel); border: 1px solid #333; padding: 20px; border-radius: 10px; text-align: center; }
        .card-title { color: #aaa; font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .card-val { font-size: 2.5rem; font-weight: bold; color: var(--gold); }
        .card-sub { font-size: 0.8rem; color: #666; margin-top: 5px; }

        /* TABLES & CHARTS LAYOUT */
        .dashboard-split { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .dashboard-split { grid-template-columns: 1fr; } }

        .panel-box { background: var(--panel); border: 1px solid #333; border-radius: 10px; padding: 20px; overflow: hidden; }
        .panel-head { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 15px; border-bottom: 1px dashed #444; padding-bottom: 10px; }

        /* TABLE STYLES */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #444; font-size: 0.9rem; }
        td { padding: 10px; border-bottom: 1px solid #222; font-family: monospace; font-size: 1rem; }
        tr:hover { background: #222; }
        .col-right { text-align: right; }
        .denom-badge { background: #333; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; border: 1px solid #555; }

        /* SEARCH WALLET */
        .search-box { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>PANEL ADMIN NUSWANTARA</h1>
            <div style="color:#666; font-size:0.8rem;">Monitoring Peredaran Uang Receh (De-denominasi)</div>
        </div>
        <div class="status"><span class="live-dot"></span>LIVE CONNECTION</div>
    </div>

    <div class="kpi-grid">
        <div class="card">
            <div class="card-title">TOTAL UANG BEREDAR</div>
            <div class="card-val" id="totalSupply">Rp 0</div>
            <div class="card-sub">Total Fisik Wajib Ada di Brankas</div>
        </div>
        <div class="card">
            <div class="card-title">JUMLAH KOIN/LEMBAR</div>
            <div class="card-val" id="totalCoins" style="color:var(--accent)">0</div>
            <div class="card-sub">Keping Token Aktif</div>
        </div>
        <div class="card">
            <div class="card-title">JUMLAH PENGGUNA</div>
            <div class="card-val" id="totalUsers" style="color:#fff">0</div>
            <div class="card-sub">Wallet ID Terdaftar</div>
        </div>
    </div>

    <div class="dashboard-split">
        <div class="panel-box">
            <div class="panel-head">RINCIAN PECAHAN (DENOMINASI)</div>
            <table id="denomTable">
                <thead>
                    <tr>
                        <th>PECAHAN</th>
                        <th class="col-right">JUMLAH (Keping)</th>
                        <th class="col-right">TOTAL NILAI</th>
                    </tr>
                </thead>
                <tbody id="denomBody">
                    <tr><td colspan="3" style="text-align:center; padding:20px;">Memuat Data...</td></tr>
                </tbody>
            </table>
            <div style="margin-top:20px; height:200px;">
                <canvas id="denomChart"></canvas>
            </div>
        </div>

        <div class="panel-box">
            <div class="panel-head">SALDO WALLET USER</div>
            <input type="text" id="searchWallet" class="search-box" placeholder="Cari ID Wallet..." onkeyup="filterWallet()">
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="walletTable">
                    <thead>
                        <tr>
                            <th>WALLET ID</th>
                            <th class="col-right">SALDO RECEH</th>
                        </tr>
                    </thead>
                    <tbody id="walletBody">
                        <tr><td colspan="2" style="text-align:center;">Memuat Data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyDVyuckZYUdUSPwX86fGy7n8KPOt7pWoVQ",
        authDomain: "pasarnuswantara.firebaseapp.com",
        databaseURL: "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "pasarnuswantara",
        storageBucket: "pasarnuswantara.firebasestorage.app",
        messagingSenderId: "8346470668",
        appId: "1:8346470668:web:86a7e8e1c19054260a2129",
        measurementId: "G-LD35EPEB7Z"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const LEDGER_NODE = 'public_ledger';

    let allWallets = []; // Untuk fitur search

    // --- 2. LOGIKA UTAMA ---
    // Kita pakai .on() biar Realtime, jadi panelnya gerak sendiri kalau ada transaksi
    db.ref(LEDGER_NODE).on('value', (snapshot) => {
        if(!snapshot.exists()) return;

        let totalMoney = 0;
        let totalCoinCount = 0;
        
        let denomStats = {}; // { 100: {count:5, val:500}, 500: {...} }
        let walletStats = {}; // { "NW-XXX": 50000, "NW-YYY": 12000 }

        snapshot.forEach((child) => {
            const data = child.val();
            
            // FILTER PENTING: HANYA RECEH
            if (data.type === 'RECEH') {
                const val = parseInt(data.val);
                const owner = data.owner || "UNKNOWN";

                if (val && !isNaN(val)) {
                    // 1. Hitung Global
                    totalMoney += val;
                    totalCoinCount++;

                    // 2. Hitung Per Pecahan
                    if (!denomStats[val]) denomStats[val] = { count: 0, sum: 0 };
                    denomStats[val].count++;
                    denomStats[val].sum += val;

                    // 3. Hitung Per Wallet
                    if (!walletStats[owner]) walletStats[owner] = 0;
                    walletStats[owner] += val;
                }
            }
        });

        updateUI(totalMoney, totalCoinCount, walletStats, denomStats);
    });

    function updateUI(totalMoney, totalCoinCount, walletStats, denomStats) {
        // Update KPI Card
        document.getElementById('totalSupply').innerText = "Rp " + totalMoney.toLocaleString('id-ID');
        document.getElementById('totalCoins').innerText = totalCoinCount.toLocaleString('id-ID');
        document.getElementById('totalUsers').innerText = Object.keys(walletStats).length;

        // Update Tabel Pecahan
        const denomBody = document.getElementById('denomBody');
        denomBody.innerHTML = "";
        
        // Sortir pecahan dari kecil ke besar
        const sortedDenoms = Object.keys(denomStats).sort((a,b) => parseInt(a) - parseInt(b));
        
        // Data untuk Grafik
        let chartLabels = [];
        let chartData = [];

        sortedDenoms.forEach(d => {
            const row = denomStats[d];
            chartLabels.push(d);
            chartData.push(row.sum);

            denomBody.innerHTML += `
                <tr>
                    <td><span class="denom-badge">Rp ${parseInt(d).toLocaleString()}</span></td>
                    <td class="col-right">${row.count.toLocaleString()}</td>
                    <td class="col-right" style="color:var(--gold);">Rp ${row.sum.toLocaleString()}</td>
                </tr>
            `;
        });
        updateChart(chartLabels, chartData);

        // Update Tabel Wallet
        const walletBody = document.getElementById('walletBody');
        walletBody.innerHTML = "";
        
        // Convert object ke array biar bisa disortir (Saldo Terbesar di atas)
        allWallets = Object.keys(walletStats).map(key => ({
            id: key,
            bal: walletStats[key]
        }));
        allWallets.sort((a,b) => b.bal - a.bal);

        allWallets.forEach(w => {
            walletBody.innerHTML += `
                <tr>
                    <td>${w.id}</td>
                    <td class="col-right" style="font-weight:bold;">Rp ${w.bal.toLocaleString()}</td>
                </tr>
            `;
        });
    }

    // Fitur Search Wallet
    function filterWallet() {
        const query = document.getElementById('searchWallet').value.toUpperCase();
        const walletBody = document.getElementById('walletBody');
        walletBody.innerHTML = "";
        
        const filtered = allWallets.filter(w => w.id.toUpperCase().includes(query));
        
        if(filtered.length === 0) {
            walletBody.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#555;">Tidak ditemukan</td></tr>`;
            return;
        }

        filtered.forEach(w => {
            walletBody.innerHTML += `
                <tr>
                    <td>${w.id}</td>
                    <td class="col-right" style="font-weight:bold;">Rp ${w.bal.toLocaleString()}</td>
                </tr>
            `;
        });
    }

    // Chart.js Setup
    let myChart = null;
    function updateChart(labels, data) {
        const ctx = document.getElementById('denomChart').getContext('2d');
        if(myChart) myChart.destroy(); // Hancurkan chart lama biar gak numpuk

        myChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Total Nilai (Rp)',
                    data: data,
                    backgroundColor: '#d4af37',
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#333' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
</script>

</body>
</html>